<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>AI è¡¨æƒ…è¾¨è­˜ç³»çµ±ï¼ˆæœ€çµ‚å¯è¾¨è­˜ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    body { font-family: 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; color: #2c3e50; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    video { width: 100%; border-radius: 10px; }
    .emotion-display { text-align: center; margin-top: 20px; }
    .current-emotion { font-size: 3em; animation: pulse 2s infinite; }
    .emotion-text { font-size: 1.5em; margin: 10px 0; }
    .warm-message { background: #fef4f4; padding: 15px; border-radius: 10px; font-size: 1.2em; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– è¡¨æƒ…è¾¨è­˜ç³»çµ±ï¼ˆåˆ†æå°æ–¹ï¼‰</h1>
    <video id="remoteVideo" autoplay playsinline muted></video>
    <div class="emotion-display">
      <div class="current-emotion" id="currentEmoji">ğŸ˜Š</div>
      <div class="emotion-text" id="emotionText">ç­‰å¾…åµæ¸¬ä¸­...</div>
      <div class="warm-message" id="warmMessage">ç³»çµ±æ­£åœ¨å•Ÿå‹•èˆ‡è¾¨è­˜ä¸­...</div>
    </div>
  </div>

  <script>
    const video = document.getElementById('remoteVideo');
    const emojiEl = document.getElementById('currentEmoji');
    const textEl = document.getElementById('emotionText');
    const msgEl = document.getElementById('warmMessage');

    const emotionConfig = {
      happy: { emoji: 'ğŸ˜Š', name: 'é–‹å¿ƒ', messages: ['ä½ çœ‹èµ·ä¾†è¶…é–‹å¿ƒè€¶ï¼ä¿æŒé€™å€‹å¿ƒæƒ…ï¼', 'ç¬‘å®¹çœŸç‡¦çˆ›ï¼'] },
      sad: { emoji: 'ğŸ˜¢', name: 'é›£é', messages: ['ä¸€åˆ‡éƒ½æœƒè®Šå¥½çš„å–”ï¼ŒåŠ æ²¹ï¼', 'çµ¦ä½ ä¸€å€‹æº«æš–çš„æ“æŠ± ğŸ«‚'] },
      angry: { emoji: 'ğŸ˜ ', name: 'ç”Ÿæ°£', messages: ['åˆ¥ç”Ÿæ°£å•¦ï½æ·±å‘¼å¸ä¸€ä¸‹ ğŸŒ¬ï¸', 'è©¦è‘—æ”¾ä¸‹ï¼Œæœƒæ›´è¼•é¬† â¤ï¸'] },
      surprise: { emoji: 'ğŸ˜²', name: 'é©šè¨', messages: ['å“‡ï¼æ˜¯é©šå–œå—ï¼ŸğŸ‰', 'å¸Œæœ›æ˜¯å¥½çš„é©šå–œå–”ï¼ğŸŒŸ'] },
      fear: { emoji: 'ğŸ˜¨', name: 'å®³æ€•', messages: ['ä¸è¦æ€•ï¼Œæœ‰æˆ‘åœ¨é€™è£¡é™ªä½  ğŸ¤—', 'å‹‡æ•¢ä¸€é»ï¼Œä½ å¾ˆæ£’ï¼'] },
      disgust: { emoji: 'ğŸ¤¢', name: 'å™å¿ƒ', messages: ['ä¸èˆ’æœå—ï¼Ÿå…ˆä¼‘æ¯ä¸€ä¸‹ ğŸ’¤'] },
      neutral: { emoji: 'ğŸ˜', name: 'å¹³éœ', messages: ['å¹³éœä¹Ÿæ˜¯ä¸€ç¨®ç¾å¥½ ğŸƒ', 'å…§å¿ƒå¯§éœæœ€é›£å¾— ğŸŒ™'] }
    };

    const peer = new Peer("analyzer-id");

    peer.on("call", call => {
      call.answer();
      call.on("stream", stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          startDetection();
        };
      });
    });

    async function startDetection() {
      const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
      console.log("ğŸ§  è¼‰å…¥æ¨¡å‹ä¸­...");
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
      ]);
      console.log("âœ… æ¨¡å‹è¼‰å…¥å®Œæˆ");
      msgEl.innerText = "âœ… æ¨¡å‹è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆ†æ...";

      const runDetection = async () => {
        if (!faceapi.nets.faceExpressionNet.isLoaded()) {
          console.log("â³ æ¨¡å‹å°šæœªå®Œå…¨è¼‰å…¥");
          return;
        }
        const result = await faceapi
          .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
          .withFaceExpressions();
        if (result && result.expressions) {
          const sorted = Object.entries(result.expressions).sort((a, b) => b[1] - a[1]);
          const [emotion] = sorted[0];
          const config = emotionConfig[emotion] || emotionConfig['neutral'];
          emojiEl.textContent = config.emoji;
          textEl.textContent = config.name;
          msgEl.textContent = config.messages[Math.floor(Math.random() * config.messages.length)];
        } else {
          textEl.textContent = "æœªåµæ¸¬åˆ°è‡‰éƒ¨";
          msgEl.textContent = "è«‹ç¢ºä¿ç•«é¢ä¸­æœ‰æ¸…æ¥šè‡‰éƒ¨å½±åƒ";
        }
      };

      setInterval(runDetection, 2000);
    }
  </script>
</body>
</html>
